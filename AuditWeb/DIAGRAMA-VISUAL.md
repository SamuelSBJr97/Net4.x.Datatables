# ?? DIAGRAMA VISUAL DO SISTEMA

## Fluxo de Dados Completo

```
???????????????????????????????????????????????????????????????????????????
?        ?? USUÁRIO           ?
?      (Navegador Web)                    ?
???????????????????????????????????????????????????????????????????????????
   ?
 ? HTTP Request
     ?
???????????????????????????????????????????????????????????????????????????
?     ?? ASP.NET MVC APPLICATION     ?
?  ?????????????????????????????????????????????????????????????????????  ?
?  ?  ?? Views (Razor)       ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?  ? _Layout.cshtml   ?  ?  ?
?  ?  ?  ?? Navbar com link "Auditoria"        ?  ?  ?
?  ?  ?  ?? Scripts: jQuery, Bootstrap, DataTables        ?  ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?  ? Audit/Index.cshtml       ?  ?  ?
?  ?  ?  ?? Dashboard (4 cards estatísticos)          ?  ?  ?
?  ?  ?  ?? DataTable HTML       ?  ?  ?
?  ?  ?  ?? JavaScript (DataTables config)            ?  ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ????????????????????????????????????????????????????????????????????  ?
?            ?   ?
?          ? AJAX POST           ?
?       ?       ?
?  ???????????????????????????????????????????????????????????????????  ?
?  ?           ?? Controllers (MVC)        ?  ?
?  ?  ?????????????????????????????????????????????????????????????? ?  ?
?  ?  ? AuditController.cs        ? ?  ?
?  ?  ?  ?? Index()        ? ?  ?
?  ?  ?  ?   ?? Carrega estatísticas    ? ?  ?
?  ?  ?  ?  ? ?  ?
?  ?  ?  ?? GetLogs(DataTablesRequest)   ? ?  ?
?  ?  ?      ?? Recebe parâmetros (draw, start, length, search)    ? ?  ?
?  ?  ?    ?? Chama Repository      ? ?  ?
?  ?  ?      ?? Retorna JSON (DataTablesResponse)         ? ?  ?
?  ?  ?????????????????????????????????????????????????????????????? ?  ?
?  ????????????????????????????????????????????????????????????????????  ?
?      ?         ?
? ? Method Call         ?
?    ?       ?
?  ???????????????????????????????????????????????????????????????????  ?
?  ???? Repositories (Data Access Layer)               ?  ?
?  ?  ?????????????????????????????????????????????????????????????? ?  ?
?  ?  ? AuditLogRepository.cs            ? ?  ?
?  ?  ?       ? ?  ?
?  ?  ?  ?? GetAuditLogs(request)        ? ?  ?
?  ?  ?  ?   ?? GetTotalRecords() ? COUNT(*)      ? ?  ?
?  ?  ?  ?   ?? GetFilteredRecords() ? COUNT(*) com WHERE        ? ?  ?
?  ?  ?  ?   ?? BuildQuery() ? SQL dinâmico               ? ?  ?
?  ?  ?  ?   ?   ?? BuildWhereClause() ? Filtros        ? ?  ?
?  ?  ?  ?   ?   ?? BuildOrderClause() ? ORDER BY       ? ?  ?
?  ?  ?  ?   ?? ExecuteQuery() ? Npgsql? ?  ?
?  ?  ?  ?        ? ?  ?
?  ?  ?  ?? GetStatistics()             ? ?  ?
?  ?  ?      ?? Agregações por severidade         ? ?  ?
?  ?  ?????????????????????????????????????????????????????????????? ?  ?
?  ????????????????????????????????????????????????????????????????????  ?
?      ?          ?
?                  ? SQL Query        ?
?  ????????????????????????????????????????????????????????????????????  ?
?  ?    ?? Data Provider (Npgsql)           ?  ?
?  ?  ?????????????????????????????????????????????????????????????? ?  ?
?  ?  ? • NpgsqlConnection             ? ?  ?
?  ?  ? • NpgsqlCommand (Prepared Statements)      ? ?  ?
?  ?  ? • NpgsqlDataReader              ? ?  ?
?  ?  ? • Connection Pooling (max 100)          ? ?  ?
?  ?  ?????????????????????????????????????????????????????????????? ?  ?
?  ???????????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????????????
         ?
   ? TCP/IP (Port 5432)
    ?
???????????????????????????????????????????????????????????????????????????
?        ?? DOCKER CONTAINER           ?
?  ?????????????????????????????????????????????????????????????????????  ?
?  ?     ?? PostgreSQL 15 Alpine         ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?  ? Database: AuditLogDB ?  ?  ?
?  ?  ? User: audituser       ?  ?  ?
?  ?  ? Password: Audit@123      ?  ?  ?
?  ?  ?   ?  ?  ?
?  ?  ? ?? Table: audit_logs  ?  ?  ?
?  ?  ?  ?? 13 colunas      ?  ?  ?
?  ?  ?  ?? 100.000 registros  ?  ?  ?
?  ?  ?  ?? 5 índices         ?  ?  ?
?  ?  ?      ?? idx_audit_logs_timestamp   ?  ?  ?
?  ?  ?      ?? idx_audit_logs_user_name         ?  ?  ?
?  ?  ?      ?? idx_audit_logs_action?  ?  ?
?  ?  ?      ?? idx_audit_logs_entity_name              ?  ?  ?
?  ?  ?      ?? idx_audit_logs_severity            ?  ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?  ? ?? Volume: postgres_data         ?  ?  ?
?  ?  ?    ?? Persistência de dados         ?  ?  ?
?  ?  ???????????????????????????????????????????????????????????????  ?  ?
?  ?????????????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????????????
```

## Fluxo de Requisição DataTables (Detalhado)

```
????????????????????????????????????????????????????????????????????????
? 1. Usuário interage com DataTable  ?
?    ?? Clica em "Próxima página"         ?
?    ?? Digita termo de busca     ?
?    ?? Clica em cabeçalho para ordenar     ?
?    ?? Altera registros por página            ?
????????????????????????????????????????????????????????????????????????
        ?
      ?
????????????????????????????????????????????????????????????????????????
? 2. DataTables JS prepara requisição            ?
?    {       ?
? "draw": 1,              ?
?      "start": 0,                 ?
?      "length": 25,   ?
?    "search": { "value": "admin" },                 ?
?  "order": [{ "column": 1, "dir": "desc" }],              ?
?      "columns": [...]       ?
?    }  ?
????????????????????????????????????????????????????????????????????????
?
       ? AJAX POST: /Audit/GetLogs
????????????????????????????????????????????????????????????????????????
? 3. AuditController.GetLogs(request)      ?
?    ?? Deserializa JSON para DataTablesRequest           ?
?    ?? Valida parâmetros   ?
????????????????????????????????????????????????????????????????????????
            ?
         ? repository.GetAuditLogs(request)
????????????????????????????????????????????????????????????????????????
? 4. AuditLogRepository.GetAuditLogs()     ?
?    ?  ?
?    ??? GetTotalRecords()      ?
?    ?   SQL: SELECT COUNT(*) FROM audit_logs       ?
?    ?   Retorna: 100000        ?
?    ?  ?
?    ??? BuildWhereClause()          ?
?    ?   Se search = "admin":            ?
?    ?   WHERE (user_name ILIKE '%admin%' OR             ?
?    ?          action ILIKE '%admin%' OR ...)     ?
?    ?    ?
?    ??? GetFilteredRecords()        ?
?    ?   SQL: SELECT COUNT(*) FROM audit_logs WHERE ...           ?
?    ?   Retorna: 10000 (registros que atendem o filtro)       ?
?    ?   ?
?    ??? BuildOrderClause()          ?
?    ?   ORDER BY timestamp DESC       ?
?    ?        ?
?    ??? BuildQuery() e ExecuteQuery()      ?
?   SQL: SELECT id, user_name, action, ...             ?
? FROM audit_logs      ?
?             WHERE (user_name ILIKE '%admin%' OR ...)     ?
?          ORDER BY timestamp DESC         ?
?       LIMIT 25 OFFSET 0      ?
????????????????????????????????????????????????????????????????????????
?
       ? SQL Query com parâmetros
????????????????????????????????????????????????????????????????????????
? 5. PostgreSQL executa query         ?
?    ?? Usa índice idx_audit_logs_timestamp    ?
?    ?? Aplica filtro WHERE         ?
?    ?? Ordena resultados           ?
?    ?? Aplica LIMIT e OFFSET    ?
?    ?? Retorna 25 registros    ?
????????????????????????????????????????????????????????????????????????
 ?
            ? ResultSet
????????????????????????????????????????????????????????????????????????
? 6. Repository mapeia para objetos          ?
?    List<AuditLog> {      ?
?      new AuditLog { Id=1, UserName="admin", ... }, ?
?      new AuditLog { Id=2, UserName="admin", ... },                  ?
?      ...             ?
?    }      ?
????????????????????????????????????????????????????????????????????????
  ?
       ? DataTablesResponse
????????????????????????????????????????????????????????????????????????
? 7. Controller monta resposta   ?
?    {  ?
?      "draw": 1,   ?
?      "recordsTotal": 100000,  ?
?      "recordsFiltered": 10000,            ?
?      "data": [ {...}, {...}, ... ]        ?
?    }       ?
????????????????????????????????????????????????????????????????????????
            ?
       ? JSON Response
????????????????????????????????????????????????????????????????????????
? 8. DataTables JS processa resposta   ?
?    ?? Limpa linhas antigas da tabela  ?
?    ?? Renderiza novas linhas        ?
?    ?? Atualiza informações de paginação     ?
?    ?   "Mostrando 1 a 25 de 10.000 registros   ?
?    ?    (filtrados de 100.000 registros)"    ?
?    ?? Atualiza botões de paginação?
?    ?? Aplica formatação (badges, datas)?
????????????????????????????????????????????????????????????????????????
```

## Arquitetura de Camadas

```
???????????????????????????????????????????????????????????????????
?        PRESENTATION LAYER          ?
?  ??????????????????????????????????????????????????????????????
?  ? • HTML/Razor Views        ?  ?
?  ? • Bootstrap CSS             ?  ?
?  ? • jQuery JavaScript     ?  ?
?  ? • DataTables Plugin       ?  ?
?  ? • Font Awesome Icons            ?  ?
?  ?????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
               ?
               ? HTTP/AJAX
        ?
???????????????????????????????????????????????????????????????????
?           CONTROLLER LAYER       ?
?  ?????????????????????????????????????????????????????????????  ?
?  ? • AuditController    ?  ?
?  ? • HomeController ?  ?
?  ? • Route Configuration           ?  ?
?  ? • Model Binding             ?  ?
?  ? • JSON Serialization    ?  ?
?  ?????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
         ?
        ? Method Calls
           ?
???????????????????????????????????????????????????????????????????
?         BUSINESS LOGIC LAYER       ?
?  ?????????????????????????????????????????????????????????????  ?
?  ? • AuditLogRepository               ?  ?
?  ? • Query Building Logic              ?  ?
?  ? • Filter Logic           ?  ?
?  ? • Statistics Calculation     ?  ?
?  ? • Data Transformation              ?  ?
?  ?????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
    ?
      ? SQL Queries
        ?
???????????????????????????????????????????????????????????????????
?         DATA ACCESS LAYER       ?
?  ?????????????????????????????????????????????????????????????  ?
?  ? • Npgsql Driver       ?  ?
?  ? • Connection Management   ?  ?
?  ? • Command Execution           ?  ?
?  ? • DataReader           ?  ?
?  ? • Connection Pooling             ?  ?
?  ?????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
       ?
    ? TCP/IP Protocol
       ?
???????????????????????????????????????????????????????????????????
?  DATABASE LAYER        ?
?  ?????????????????????????????????????????????????????????????  ?
?  ? • PostgreSQL Server         ?  ?
?  ? • Query Optimizer ?  ?
?  ? • Index Manager        ?  ?
?  ? • Transaction Manager              ?  ?
?  ? • Storage Engine    ?  ?
?  ?????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
```

## Estrutura de Dados

```
audit_logs (PostgreSQL Table)
???????????????????????????????????????????????????????????????????
? PK: id (SERIAL)             ?    ?
???????????????????????????????????????????????????????????????????
? user_name      VARCHAR(100)   NOT NULL    idx ?  ?
? action    VARCHAR(100)   NOT NULL    idx ?             ?
? entity_name    VARCHAR(100)   NULL    idx ?               ?
? entity_id      VARCHAR(50)    NULL            ?
? old_values     TEXT      NULL    ?
? new_values     TEXT      NULL    ?
? ip_address     VARCHAR(45)    NULL ?
? user_agent     TEXT           NULL         ?
? timestamp      TIMESTAMP      NOT NULL    idx ?     ?
? severity  VARCHAR(20)    NOT NULL    idx ?       ?
? message        TEXT           NULL           ?
? exception_details TEXT        NULL ?
???????????????????????????????????????????????????????????????????

Índices (B-Tree):
?? idx_audit_logs_timestamp ? ORDER BY rápido
?? idx_audit_logs_user_name     ? Busca por usuário
?? idx_audit_logs_action      ? Busca por ação
?? idx_audit_logs_entity_name   ? Busca por entidade
?? idx_audit_logs_severity      ? Filtro por severidade
```

## Performance Optimization

```
???????????????????????????????????????????????????????????????????
?         Query sem filtro        ?
?  SELECT * FROM audit_logs ORDER BY timestamp DESC          ?
?  LIMIT 25 OFFSET 0        ?
?             ?
?  ? Usa: idx_audit_logs_timestamp ?
?  ? Tempo: ~50ms       ?
?  ? Rows scanned: 25    ?
???????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
?           Query com filtro         ?
?  SELECT * FROM audit_logs    ?
?  WHERE user_name ILIKE '%admin%'       ?
?  ORDER BY timestamp DESC            ?
?LIMIT 25 OFFSET 0             ?
?           ?
?  ? Usa: idx_audit_logs_user_name + idx_audit_logs_timestamp    ?
?? Tempo: ~100ms    ?
?  ? Rows scanned: ~10,000 (filtrados para 25)   ?
???????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
?        Connection Pooling               ?
?  ???????????????           ?
?  ? Pool (100)  ?  ? Connection reuse         ?
?  ???????????????  ?
?  ? Conn 1  ? ?  ? Active   ?
?  ? Conn 2  ?   ?  ? Active  ?
?  ? Conn 3  ?   ?  ? Idle       ?
?  ? ...         ?               ?
?  ???????????????       ?
?       ?
?  ? Vantagens:           ?
?    • Reduz overhead de conexão        ?
? • Suporta múltiplos usuários  ?
?    • Auto-gerenciamento ?
???????????????????????????????????????????????????????????????????
```

## Docker Container Lifecycle

```
???????????????????????????????????????????????????????????????????
?  docker-compose up -d        ?
???????????????????????????????????????????????????????????????????
      ?
     ?
???????????????????????????????????????????????????????????????????
?1. Pull PostgreSQL 15 Alpine image      ?
???????????????????????????????????????????????????????????????????
           ?
      ?
???????????????????????????????????????????????????????????????????
?  2. Create container 'auditlog_postgres'      ?
?  ?? Port mapping: 5432:5432      ?
?     ?? Environment variables           ?
?     ?   ?? POSTGRES_DB=AuditLogDB ?
??   ?? POSTGRES_USER=audituser  ?
?     ?   ?? POSTGRES_PASSWORD=Audit@123            ?
?     ?? Volume: postgres_data       ?
???????????????????????????????????????????????????????????????????
               ?
        ?
???????????????????????????????????????????????????????????????????
?  3. PostgreSQL initialization    ?
?     ?? Create database              ?
?     ?? Create user          ?
?     ?? Run init-db.sql   ?
???????????????????????????????????????????????????????????????????
        ?
           ?
???????????????????????????????????????????????????????????????????
?  4. Execute init-db.sql      ?
?     ?? CREATE TABLE audit_logs         ?
?   ?? CREATE INDEXES (5x)           ?
?     ?? CREATE FUNCTION random_between()      ?
?     ?? INSERT 100,000 records (DO $$ loop)        ?
?      ?         ?
?   ?? Progress: 10,000 records... ?         ?
?         ?? Progress: 20,000 records... ?            ?
?   ?? Progress: 30,000 records... ?  ?
?         ?? ...                ?
?         ?? Progress: 100,000 records ?   ?
???????????????????????????????????????????????????????????????????
   ?
         ?
???????????????????????????????????????????????????????????????????
?  5. Container ready and healthy ?  ?
?     ?? Status: Up              ?
?     ?? Health: Healthy                   ?
?     ?? Ready to accept connections                   ?
???????????????????????????????????????????????????????????????????
```

---

**Última atualização**: 2025
**Versão**: 1.0
